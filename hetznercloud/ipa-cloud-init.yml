#cloud-config
# --- USERS ---
users:
  - default

  # Generic human user account
  - name: genericbcuser
    gecos: Generic Linux Blessing Consulting User 
    groups: [sudo]
    shell: /bin/bash
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: false
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILrWSFBA3/5MKjubnwl6NGd3TytWnz0NOruyiFOPtnaz

  # Service account (no sudo, no shell)
  - name: svcbcappuser
    gecos: Application Service Account
    groups: []
    shell: /bin/bash
    sudo: ""
    lock_passwd: true
    ssh_authorized_keys: []

# --- SSH CONFIGURATION ---
ssh_pwauth: false   # disable password auth (optional but recommended)

# --- DISABLE ROOT REMOTE LOGIN (Guaranteed) ---
write_files:
  - path: /etc/ssh/sshd_config.d/disable_root.conf
    permissions: '0644'
    content: |
      PermitRootLogin no

# --- FAIL2BAN ---
packages:
  - fail2ban

write_files:
  - path: /etc/fail2ban/jail.local
    permissions: '0644'
    content: |
      [sshd]
      enabled = true
      filter = sshd
      backend = systemd
      maxretry = 5
      bantime = 10m
      findtime = 10m


# --- RUNCMD ---
runcmd:
  # Ensure no conflicting PermitRootLogin lines exist
  - sed -i '/^PermitRootLogin/d' /etc/ssh/sshd_config
  - echo "PermitRootLogin no" >> /etc/ssh/sshd_config
  - systemctl restart sshd

  # --- MOUNT /dev/sdb ON /data ---
  - mkdir -p /data
  - |
      if ! blkid /dev/sdb; then
        mkfs.ext4 -F /dev/sdb
      fi
  - |
      UUID=$(blkid -s UUID -o value /dev/sdb)
      grep -q "$UUID" /etc/fstab || echo "UUID=$UUID /data ext4 defaults,nofail 0 2" >> /etc/fstab
  - mount -a

  # Create structure & permissions
  - mkdir -p /data/app /data/logs
  - chown -R appsvc:appsvc /data
  - chmod 755 /data /data/app /data/logs

  - systemctl enable fail2ban
  - systemctl restart fail2ban

