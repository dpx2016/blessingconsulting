#cloud-config
# --- USERS ---
users:
  - default

  - name: genericbcuser
    gecos: Generic Linux Blessing Consulting User
    groups: [wheel]
    shell: /bin/bash
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: false
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILrWSFBA3/5MKjubnwl6NGd3TytWnz0NOruyiFOPtnaz

# --- SSH CONFIGURATION ---
ssh_pwauth: false

# --- FILES & CONFIGURATION ---
write_files:

  # Disable root login via SSH
  - path: /etc/ssh/sshd_config.d/disable_root.conf
    permissions: '0644'
    content: |
      PermitRootLogin no

  # Fail2ban configuration
  - path: /etc/fail2ban/jail.local
    permissions: '0644'
    content: |
      [sshd]
      enabled = true
      filter = sshd
      backend = systemd
      maxretry = 5
      bantime = 10m
      findtime = 10m

  # --- Dynamic static route generator for Hetzner multi-network setup ---
  - path: /usr/local/bin/setup-static-routes.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Detect network interfaces for 10.0.x.x and 10.10.x.x
      CORE_IF=$(ip -o -4 addr show | awk '/10\.0\./ {print $2}')

      echo "Detected CORE_IF=$CORE_IF"

      # Route VPN traffic through pfSense
      if [ -n "$CORE_IF" ]; then
        echo "10.99.0.0/24 via 10.0.0.2 dev $CORE_IF" > /etc/sysconfig/network-scripts/route-$CORE_IF
      fi

      nmcli connection reload || true

  # --- Force FreeIPA to use pfSense DNS forwarders ---
  - path: /etc/NetworkManager/conf.d/90-dns-override.conf
    permissions: '0644'
    content: |
      [main]
      dns=none

  # System resolver BEFORE IPA install
  - path: /etc/resolv.conf
    permissions: '0644'
    content: |
      search blessingconsulting.intra
      nameserver 10.0.0.2

# --- PACKAGES ---
packages:
  - fail2ban
  - freeipa-server
  - freeipa-server-dns
  - freeipa-client
  - fail2ban
  - firewalld


# --- COMMANDS ---
runcmd:

  # Set system hostname
  - hostnamectl set-hostname ipa.blessingconsulting.intra

  # Add host entry (adjust IP as needed)
  - echo "10.0.0.3 ipa.blessingconsulting.intra ipa" >> /etc/hosts

  # SSH reload
  - systemctl restart sshd

  # Set timezone to Africa/Douala
  - timedatectl set-timezone Africa/Douala

  # Fail2ban
  - systemctl enable fail2ban
  - systemctl restart fail2ban

  # Enable firewalld for FreeIPA
  - systemctl enable firewalld
  - systemctl restart firewalld

  # Add firewalld rules to allow FreeIPA services (HTTP, HTTPS, LDAP, Kerberos, DNS, etc.)
  - |
      firewall-cmd --permanent --add-service={http,https,ldap,ldaps,kerberos,dns,ntp,kpasswd,kadmin}
      firewall-cmd --permanent --add-port=88/udp
      firewall-cmd --permanent --add-port=464/udp
      firewall-cmd --reload

  # Install static routes
  - bash /usr/local/bin/setup-static-routes.sh

  # Apply DNS override
  - nmcli general reload || true

  # --------------------
  # --- FREEIPA INSTALL ---
  # --------------------
  - |
      ipa-server-install \
        --unattended \
        --realm=BC.INTRA \
        --domain=blessingconsulting.intra \
        --hostname=ipa.blessingconsulting.intra \
        --ip-address=$(hostname -I | awk '{print $1}') \
        --mkhomedir \
        --admin-password='ChangeMe123!' \
        --ds-password='ChangeMe123!' \
        --setup-dns \
        --allow-zone-overlap \
        --forwarder=10.0.0.2 \
        --forwarder=10.10.0.2

  - systemctl enable ipa
  - systemctl restart ipa

# --- FINAL MESSAGE ---
final_message: "The system is finally up, FreeIPA server is installed and configured."