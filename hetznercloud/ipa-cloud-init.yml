#cloud-config
# --- USERS ---
users:
  - default

  # Generic human user account
  - name: genericbcuser
    gecos: Generic Linux Blessing Consulting User 
    groups: [sudo]
    shell: /bin/bash
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: false
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILrWSFBA3/5MKjubnwl6NGd3TytWnz0NOruyiFOPtnaz

  # Service account (no sudo, no shell)
  - name: svcbcappuser
    gecos: Application Service Account
    groups: []
    shell: /bin/bash
    sudo: ""
    lock_passwd: true
    ssh_authorized_keys: []

# --- SSH CONFIGURATION ---
ssh_pwauth: false   # disable password auth (optional but recommended)

# --- FAIL2BAN ---
packages:
  - fail2ban

write_files:
  - path: /etc/fail2ban/jail.local
    permissions: '0644'
    content: |
      [sshd]
      enabled = true
      filter = sshd
      backend = systemd
      maxretry = 5
      bantime = 10m
      findtime = 10m
  - path: /etc/ssh/sshd_config.d/disable_root.conf
    permissions: '0644'
    content: |
      PermitRootLogin no

# --- RUNCMD ---
runcmd:
  # Ensure root login is disabled
  - sed -i '/^PermitRootLogin/d' /etc/ssh/sshd_config
  - echo "PermitRootLogin no" >> /etc/ssh/sshd_config
  - systemctl restart sshd

  # Enable fail2ban
  - systemctl enable fail2ban
  - systemctl restart fail2ban
