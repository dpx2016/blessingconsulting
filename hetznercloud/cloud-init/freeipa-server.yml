#cloud-config
hostname: ipa
fqdn: ipa.cabinetblessingconsulting.intra
manage_etc_hosts: false

###############################################################################
# USER CONFIG â€” Generic user with SSH key
###############################################################################
users:
  - default

  - name: genericbcuser
    gecos: Generic Linux Blessing Consulting User
    groups: [wheel]
    shell: /bin/bash
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: false
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILrWSFBA3/5MKjubnwl6NGd3TytWnz0NOruyiFOPtnaz

# --- SSH CONFIGURATION ---
ssh_pwauth: false

# --- FILES & CONFIGURATION ---
write_files:

  # Disable root login via SSH
  - path: /etc/ssh/sshd_config.d/disable_root.conf
    permissions: '0644'
    content: |
      PermitRootLogin no

  # Fail2ban configuration
  - path: /etc/fail2ban/jail.local
    permissions: '0644'
    content: |
      [sshd]
      enabled = true
      filter = sshd
      backend = systemd
      maxretry = 5
      bantime = 10m
      findtime = 10m

###############################################################################
# PACKAGES (network is ready here)
###############################################################################
package_update: true
package_upgrade: true

###############################################################################
# FREEIPA INSTALL
###############################################################################
runcmd:
  # Set timezone to Africa/Douala
  - timedatectl set-timezone Africa/Douala
  
  # Fill /etc/hosts with the hostname and IP address
  - 
  # Change keyboard layout to FR (AZERTY) 
  - localectl set-keymap fr
  
  # Remove hc-utils if installed (conflicts with FreeIPA)
  - dnf -y remove hc-utils

  # FreeIPA installation script
  - |
    set -e

    STATIC_IP="10.0.1.2/32"
    GATEWAY="10.0.0.1"
    DNS="185.12.64.2"

    echo "Preparing network configuration"
    DOMAIN="cabinetblessingconsulting.intra"
    REALM="CABINETBLESSINGCONSULTING.INTRA"
    HOSTNAME="ipa.cabinetblessingconsulting.intra"
    ADMIN_PASS=$(openssl rand -base64 24)
    DM_PASS=$(openssl rand -base64 24)

    echo "Admin password: $ADMIN_PASS" > /root/ipa-secrets.txt
    echo "Directory Manager password: $DM_PASS" >> /root/ipa-secrets.txt
    chmod 600 /root/ipa-secrets.txt

    echo "[1/10] Disable Hetzner DHCP service"
    systemctl stop hc-net-ifup@eth0.service || true
    systemctl disable --now hc-net-ifup@eth0.service || true
    systemctl mask hc-net-ifup@eth0.service || true

    echo "[2/10] Remove any existing eth0 connections"
    nmcli connection delete eth0 || true

    echo "[3/10] Create static eth0 connection"    
    nmcli connection add con-name eth0 ifname eth0 type ethernet ip4 $STATIC_IP gw4 $GATEWAY
    nmcli connection modify eth0 ipv4.method manual
    nmcli connection modify eth0 ipv4.dns "$DNS"
    nmcli connection modify eth0 ipv4.never-default no

    echo "[4/10] Bring up eth0"
    nmcli connection up eth0

    echo "[5/10] Verify network"
    ip addr show eth0
    ip route
    cat /etc/resolv.conf

    echo "[5/10] Install fail2ban, firewall  & chrony packages"
    dnf -y install chrony firewalld epel-release 
    dnf -y install fail2ban

    echo "[6/10] Enable services"
    systemctl enable --now chronyd firewalld

    echo "[7/10] Disable firewall for FreeIPA"
    systemctl stop firewalld         
    systemctl disable firewalld      
    systemctl mask firewalld         

    echo "[8/10] Detect local IPA IP"
    IPA_IP=$(nmcli -g IP4.ADDRESS device show eth0 | awk -F/ '{print $1}')
    if [[ -z "$IPA_IP" ]]; then
      echo "ERROR: Could not detect IP"
      exit 1
    fi
    echo "Using IPA IP: $IPA_IP"

    # update /etc/hosts file
    echo "${IPA_IP}  ${HOSTNAME} ${HOSTNAME%%.*}" >> /etc/hosts

    echo "Install freeipa packages"
    dnf -y install ipa-server ipa-server-dns ipa-client ipa-server-trust-ad

    echo "[9/10] Install FreeIPA"

    ipa-server-install \
      --hostname=${HOSTNAME} \
      --domain=${DOMAIN} \
      --realm=${REALM} \
      --ip-address=${IPA_IP} \
      --ds-password=${DM_PASS} \
      --admin-password=${ADMIN_PASS} \
      --setup-dns \
      --auto-reverse \
      --no-forwarders \
      --unattended

    echo "Disable root login via SSH"
    sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
    systemctl restart sshd

    echo "Ensure genericbcuser home permissions"
    chmod 700 /home/genericbcuser
    chown genericbcuser:genericbcuser /home/genericbcuser

    echo "You can now access the FreeIPA web interface at https://${IPA_IP}/ipa/ui/"

  # "Enable and restart services"
  - systemctl enable ipa 
  - systemctl restart ipa

  # create pfsense-bind user
  - ipa user-add pfsense-bind   --first=pfSense   --last=LDAP   --shell=/sbin/nologin   --password
  - ipa user-mod pfsense-bind --password-expiration=20380119031407Z

  # create pfsense-bind permisions and privileges
  - ipa privilege-add pfsense-ldap-read   --desc="Read-only LDAP access for pfSense"
  - ipa permission-add "pfSense Read Users" --type=user --right=read --bindtype=permission
  - ipa permission-add "pfSense Read Groups" --type=group --right=read --bindtype=permission
  - ipa privilege-add-permission pfsense-ldap-read  --permissions="pfSense Read Users"  --permissions="pfSense Read Groups"
  - ipa privilege-add-permission pfsense-ldap-read --permissions="pfSense Read Membership"  
  - ipa role-add pfsense-ldap-reader   --desc="pfSense LDAP bind role"
  - ipa role-add-privilege pfsense-ldap-reader   --privileges=pfsense-ldap-read
  - ipa role-add-member pfsense-ldap-reader   --users=pfsense-bind   

  # create odoo-bind user
  - ipa user-add odoo-bind   --first=Odoo   --last=LDAP   --shell=/sbin/nologin   --password
  - ipa user-mod odoo-bind --password-expiration=20380119031407Z

  # create odoo-bind permisions and privileges
  - ipa privilege-add odoo-ldap-read   --desc="Read-only LDAP access for Odoo"
  - ipa permission-add "Odoo Read Users" --type=user --right=read --bindtype=permission
  - ipa permission-add "Odoo Read Groups" --type=group --right=read --bindtype=permission
  - ipa permission-add "Odoo Read Membership" --type=memberof --right=read --bindtype=permission
  - ipa privilege-add-permission odoo-ldap-read  --permissions="Odoo Read Users"  --permissions="Odoo Read Groups"  --permissions="Odoo Read Membership"
  - ipa role-add odoo-ldap-reader   --desc="Odoo LDAP bind role"
  - ipa role-add-privilege odoo-ldap-reader   --privileges=odoo-ldap-read 
  - ipa role-add-member odoo-ldap-reader   --users=odoo-bind    