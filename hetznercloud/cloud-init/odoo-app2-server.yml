#cloud-config
hostname: odoo-app2
fqdn: odoo-app2.cabinetblessingconsulting.intra
manage_etc_hosts: false

# ---------------------------------------------------
# Timezone & locale
# ---------------------------------------------------
timezone: Africa/Douala
locale: fr_FR.UTF-8

keyboard:
  layout: fr
  variant: azerty

# ---------------------------------------------------
# Users
# ---------------------------------------------------
users:
  - default

  - name: genericbcuser
    gecos: Generic Linux Blessing Consulting User
    groups: [sudo]
    shell: /bin/bash
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: false
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILrWSFBA3/5MKjubnwl6NGd3TytWnz0NOruyiFOPtnaz

  - name: odoo
    system: true
    shell: /usr/sbin/nologin
    ssh_authorized_keys: []
    lock_passwd: true

# ---------------------------------------------------
# SSH hardening
# ---------------------------------------------------
ssh_pwauth: false
disable_root: true

# --- FILES & CONFIGURATION ---
write_files:

  # Disable root login via SSH
  - path: /etc/ssh/sshd_config.d/disable_root.conf
    permissions: '0644'
    content: |
      PermitRootLogin no

  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    permissions: "0644"
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      PubkeyAuthentication yes
      AllowUsers genericbcuser

  # Fail2ban configuration
  - path: /etc/fail2ban/jail.local
    permissions: '0644'
    content: |
      [sshd]
      enabled = true
      filter = sshd
      backend = systemd
      maxretry = 5
      bantime = 10m
      findtime = 10m

# ---------------------------------------------------
# Network configuration (disable DHCP, static IP)
# ---------------------------------------------------
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: false
      dhcp6: false
      addresses:
        - 10.0.1.3/32
      routes:
        - to: default
          via: 10.0.0.1
      nameservers:
        addresses:
          - 185.12.64.2


# ---------------------------------------------------
# Services
# ---------------------------------------------------
runcmd:
  # Wait until network is reachable
  - |
    until ping -c1 185.12.64.2 >/dev/null 2>&1; do
      sleep 2
    done

  # Ensure ufw is fully disabled (pfSense handles firewalling)
  - systemctl stop ufw || true
  - systemctl disable ufw || true
  - ufw --force reset || true

  # Update & install packages
  - apt-get update
  - DEBIAN_FRONTEND=noninteractive apt-get -y upgrade
  - DEBIAN_FRONTEND=noninteractive apt-get -y install \
      fail2ban \
      ca-certificates \
      curl \
      gnupg \
      lsb-release

  # Enable fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Reload SSH
  - systemctl restart ssh

final_message: |
  Cloud-init complete.
  Static networking active.
  Packages installed after network initialization.
  UFW disabled (pfSense firewall).
