#cloud-config
hostname: metrics.cabinetblessingconsulting.intra
fqdn: metrics.cabinetblessingconsulting.intra
manage_etc_hosts: false

# ---------------------------------------------------
# Timezone & locale
# ---------------------------------------------------
timezone: Africa/Douala
locale: fr_FR.UTF-8

keyboard:
  layout: fr
  variant: azerty

# ---------------------------------------------------
# Users
# ---------------------------------------------------
users:
  - default

  - name: genericbcuser
    gecos: Generic Linux Blessing Consulting User
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILrWSFBA3/5MKjubnwl6NGd3TytWnz0NOruyiFOPtnaz

  - name: odoo
    system: true
    shell: /usr/sbin/nologin
    ssh_authorized_keys: []
    lock_passwd: true

# ---------------------------------------------------
# SSH hardening
# ---------------------------------------------------
ssh_pwauth: false
disable_root: true

# --- FILES & CONFIGURATION ---
write_files:

  - path: /etc/ssh/sshd_config.d/ssh-hardening.conf
    permissions: "0644"
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      PubkeyAuthentication yes
      ChallengeResponseAuthentication no
      X11Forwarding no
      AllowTcpForwarding yes
      AllowAgentForwarding yes 
      AuthorizedKeysFile .ssh/authorized_keys
      AllowUsers genericbcuser 

  - path: /etc/update-motd.d/99-blessing-banner
    permissions: '0755'
    content: |
      #!/bin/bash
      echo "========================================================"
      echo "  WELCOME TO BLESSING CONSULTING IT INFRA - METRICS NODE"
      echo "  IP Address: $(hostname -I | cut -d' ' -f1)"
      echo "  Hostname : $(hostname | cut -d' ' -f1)"
      echo "  Status: Passwordless SSH Enabled (Internal)"
      echo "========================================================"


  # -----------------------------
  # Netplan (static networking)
  # -----------------------------
  - path: /etc/netplan/60-my-private-network.yaml
    permissions: "0600"
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          enp7s0:
            dhcp4: false
            dhcp6: false
            addresses:
              - 10.0.1.5/32
            routes:
              - to: 10.0.0.1/32
                scope: link            
              - to: default
                via: 10.0.0.1
                on-link: true
            nameservers:
              addresses: [10.0.1.2, 185.12.64.2]
              search: [cabinetblessingconsulting.intra]

# ---------------------------------------------------
# Services
# ---------------------------------------------------
runcmd:

  - |
      cat <<EOF > /home/genericbcuser/.ssh/id_ed25519
      -----BEGIN OPENSSH PRIVATE KEY-----
      b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
      QyNTUxOQAAACC61khQQN/+TCo7m58JejRnd08rVp89DTq7sohTj7Z2swAAAKAQFcUHEBXF
      BwAAAAtzc2gtZWQyNTUxOQAAACC61khQQN/+TCo7m58JejRnd08rVp89DTq7sohTj7Z2sw
      AAAEBr1V8aaaSQA/Eaf0Aab2z1AoKuTE/+9xCFiiRLi6u+07rWSFBA3/5MKjubnwl6NGd3
      TytWnz0NOruyiFOPtnazAAAAHURlZmF1bHQgaGV0em5lciBTU0ggS2V5cyBwYWly
      -----END OPENSSH PRIVATE KEY-----
      EOF
  - chown genericbcuser:genericbcuser /home/genericbcuser/.ssh/id_ed25519
  - chmod 600 /home/genericbcuser/.ssh/id_ed25519

  - |
      cat <<EOF > /home/genericbcuser/.ssh/id_ed25519.pub
      ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILrWSFBA3/5MKjubnwl6NGd3TytWnz0NOruyiFOPtnaz
      EOF
  - chown genericbcuser:genericbcuser /home/genericbcuser/.ssh/id_ed25519.pub
  - chmod 644 /home/genericbcuser/.ssh/id_ed25519.pub

    # 3. Write the SSH Config to skip host checking
  - |
    cat <<EOF > /home/genericbcuser/.ssh/config
    Host *
        StrictHostKeyChecking no
        UserKnownHostsFile /dev/null
    EOF
  - chown genericbcuser:genericbcuser /home/genericbcuser/.ssh/config
  - chmod 600 /home/genericbcuser/.ssh/config

  # Disable hc-net-ifup service to avoid conflicts
  - systemctl stop hc-net-ifup@enp7s0.service
  - systemctl mask hc-net-ifup@enp7s0.service
  - sudo netplan generate
  - sudo netplan apply

  # Wait until network is reachable
  - |
    until ping -c1 185.12.64.2 >/dev/null 2>&1; do
      sleep 2
    done

  # Ensure ufw is fully disabled (pfSense handles firewalling)
  - systemctl stop ufw || true
  - systemctl disable ufw || true
  - ufw --force reset || true

  # Reload SSH
  - systemctl restart ssh

  # ssh config for genericbcuser
  - echo "Host *" >> /home/genericbcuser/.ssh/config
  - echo "    StrictHostKeyChecking no" >> /home/genericbcuser/.ssh/config
  - chown genericbcuser:genericbcuser /home/genericbcuser/.ssh/config
  - chmod 600 /home/genericbcuser/.ssh/config 

  # Disable MOTD help text
  - chmod -x /etc/update-motd.d/10-help-text 

    # apply netplan once again to ensure network is correctly configured
  - sudo netplan generate
  - sudo netplan apply
